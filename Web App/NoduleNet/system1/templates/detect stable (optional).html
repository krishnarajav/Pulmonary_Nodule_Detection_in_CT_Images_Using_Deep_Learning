{% extends 'base.html' %}
{% load static %}
{% block head %}
    <title>NoduleNet - Detect</title>
    <link rel="stylesheet" href="{% static 'css/detect.css' %}">
{% endblock %}

{% block underline3 %}
    <div class="line"></div>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="content">
            <div class="display">

                <div class="corner-border">
                    <div class="corner top-left"></div>
                    <div class="corner top-right"></div>
                    <div class="corner bottom-left"></div>
                    <div class="corner bottom-right"></div>
                </div>

                <div class="perform">
                    <form id="image-upload-form" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="buttons-container">
                            <div class="upload-button">
                                <img class="upload" alt="upload" src="{% static 'images/Upload_Button.png' %}">
                                <input class="file-upload" type="file" id="file-input" name="image" />
                            </div>
                            <button class="run-button">
                                <img class="run" alt="run" src="{% static 'images/Run_Button.png' %}">
                            </button>
                        </div>
                    </form>
                    
                    <div class="images">
                        <div class="img-display">
                            {% if display_img %}
                                <img class="show-img" alt="display-img" src="{{ display_img }}">
                            {% else %}
                                <img class="show-img" alt="img-not-available" src="{% static 'images/Image_Not_Available.png' %}">
                            {% endif %}
                        </div>
                    </div>

                    <div class="model-details">
                        <p>Version: 1.0<br>Status: Ready<br>Accuracy: 82.6%<br>Last Updated: 21-11-2024<br>Analysis: Pending</p>

                        <!--model details
                        <p>Version: {{ model_version }}<br>Status: {{ status }}<br>Accuracy: {{ model_accuracy }}<br>Last Updated: {{ updated_date }}</p>
                        -->
                    </div>
                </div>

            </div>
            <div class="sidebar">
                <div class="nodule-count">
                    <p class="count-title">Lung Nodules &nbsp;</p>
                    <p class="count-no">2</p>

                    <!--nodule count
                    <p class="count-no">{{ nodule_count }}</p>
                    -->

                </div>

                <table>
                    <thead class="nodule-detail-head">
                        <tr>
                            <th>Number</th>
                            <th>Diameter (mm)</th>
                            <th>Location (px x px)</th>
                        </tr>
                    </thead>
                    <tbody class="nodule-detail">
                        <tr>
                            <td>1</td>
                            <td>3.5</td>
                            <td>101x153</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>3.5</td>
                            <td>101x153</td>
                        </tr>

                        <!-- to display nodule details
                        {% for nodule in nodule_details %}
                            <tr>
                                <td>{{ forloop.counter }}</td> 
                                <td>{{ nodule.diameter }}</td>
                                <td>{{ nodule.location }}</td>
                            </tr>
                            {% endfor %}
                        -->

                    </tbody>
                </table>
                
            </div>
        </div>
    </div>

    <script>
        function attachFileInputListener() {
            const fileInput = document.getElementById('file-input');
            if (!fileInput) return;

            fileInput.addEventListener('change', function () {
                const form = document.getElementById('image-upload-form');
                const formData = new FormData(form);

                fetch('', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}', // CSRF token for security
                    },
                })
                    .then(response => response.text())
                    .then(data => {
                        document.body.innerHTML = data; // Replace the entire page with the new content
                        attachFileInputListener(); // Reattach event listener to the updated DOM
                    })
                    .catch(error => console.error('Error:', error));
            });
        }

        // Attach the listener when the page loads
        attachFileInputListener();
    </script>
{% endblock %}  